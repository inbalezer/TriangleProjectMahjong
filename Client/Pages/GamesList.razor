@page "/GamesList"
@using TriangleProject.Shared.Models.Editor
@using TriangleProject.Shared.Models.Matches

@inject HttpClient Http

<h3>GamesList</h3>

@if (user != null)
{
	<p>The Games:</p>
	<table border=0>
		<tr>
			<th>ID</th>
			<th>Game Name</th>
			<th>Game Code</th>
			<th>Publish</th>
		</tr>

		@foreach (GameForEditor game in user.UserGames)
		{
			<tr>
				<td>@counter</td>
				<td>@game.GameFullName</td>
				<td>@game.GameCode</td>
				<td>
					@if (game.PublishStatus == "Not Eligible")
					{
						<input type="checkbox" disabled />
					}
					else if (game.PublishStatus == "Eligible")
					{
						<input type="checkbox" @onchange="(()=> changePublish(game))"/>
					}
					else
					{
						<input type="checkbox" checked @onchange="(()=> changePublish(game))" />
					}
				</td>
			</tr>
			counter = counter + 1;
		}
	</table>

}

@inject NavigationManager Nav
@if (msg != "")
{
	<p>@msg</p>
	<input type="button" value="reload" @onclick=Navigate />
}





@code {

	[CascadingParameter]
	public int UserId { get; set; }

	UserWithGames user;
	int counter = 1;
	string msg = "";

	protected override async Task OnInitializedAsync() 
	{
		var userRes = await Http.GetAsync("api/Games/" + UserId);

		if (userRes.IsSuccessStatusCode)
		{
			user = userRes.Content.ReadFromJsonAsync<UserWithGames>().Result;
		}
		else
		{
			string error = userRes.Content.ReadAsStringAsync().Result;
			switch (error)
			{
				case "No Session":
					msg = "Session error, please reload page";
					break;
				case "User Not Logged In":
					msg = "You are not logged in, please reload page to try again";
					break;
				case "User Not Found":
					msg = "the user details not found, please reload page to try again";
					break;
			}
		}
	}

	void Navigate()
	{
		Nav.NavigateTo("./", true);
	}

	protected async Task changePublish(GameForEditor game)
	{
		GamePublish gameToSend = new GamePublish();
		gameToSend.ID = game.ID;
		gameToSend.PublishStatus = game.PublishStatus;

		if (gameToSend.PublishStatus == "Eligible")
		{
			gameToSend.PublishStatus = "Published";
		}
		else
		{
			gameToSend.PublishStatus = "Eligible";
		}

		var userRes = await Http.PostAsJsonAsync("api/Games/" + UserId + "/publishGame", gameToSend);

		if (userRes.IsSuccessStatusCode)
		{
			int index = user.UserGames.IndexOf(game);
			if (user.UserGames[index].PublishStatus == "Eligible")
			{
				user.UserGames[index].PublishStatus = "Published";
			}
			else
			{
				user.UserGames[index].PublishStatus = "Eligible";
			}
			
		}

		else
		{
			string error = userRes.Content.ReadAsStringAsync().Result;
			
			switch (error)
			{
				case "No Session":
					msg = "Session error, please reload page";
					break;

				case "User Not Logged In":
					msg = "You are not logged in, please reload page to try again";
					break;

				case "It's Not Your Game":
					msg = "You tried to update a game that is not associated with your user ";
					break;
			}

		}
	}
}